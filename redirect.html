function doPost(e) {
    try {
        // Ouvrir la feuille Google Sheets par ID
        const sheet = SpreadsheetApp.openById("1HU-e4w_wVvsk7pWoP02fqA5feXhLBxJ15cde3NynvfE").getActiveSheet();
        const data = e.parameter;

        // Calcul de l'âge à partir de la date de naissance
        let age = "Non renseigné";
        if (data['Jour'] && data['Mois'] && data['Année']) {
            const dob = new Date(data['Année'], data['Mois'] - 1, data['Jour']);
            const diff = new Date() - dob;
            age = Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
        }

        // Traitement des disponibilités
        const disponibilites = Array.isArray(data['Dates disponibles[]']) 
            ? data['Dates disponibles[]'].join(", ") 
            : data['Dates disponibles[]'] || "Non renseigné";

        // Validation du droit à l'image
        const droitImage = data['Droit à l\'image'] || "Non renseigné";

        // Validation de l'affiliation
        const affiliation = data['Affiliation'] || "Non renseigné";

        // Ajouter les données dans Google Sheets
        sheet.appendRow([
            data['Nom complet'],             // Colonne A : Nom complet
            data['Prénom'],                  // Colonne B : Prénom
            age,                             // Colonne C : Âge
            data['Genre'],                   // Colonne D : Genre
            data['Email'],                   // Colonne E : E-mail
            data['Téléphone'],               // Colonne F : Téléphone
            disponibilites,                  // Colonne G : Disponibilités
            droitImage,                      // Colonne H : Droit à l'image
            affiliation,                     // Colonne I : Affiliation
            "En attente"                     // Colonne J : Statut
        ]);

        // Envoyer un email de confirmation
        const email = data['Email'];
        const nomComplet = data['Nom complet'];
        const prenom = data['Prénom'];
        if (email) {
            MailApp.sendEmail({
                to: email,
                subject: "Confirmation de votre inscription aux ateliers d'improvisation",
                body: `Bonjour ${prenom} ${nomComplet},

Merci pour votre inscription aux ateliers de théâtre d'improvisation du Secours Populaire de Paris.
Nous avons bien reçu vos informations :
- Nom complet : ${nomComplet}
- Prénom : ${prenom}
- Âge : ${age}
- Genre : ${data['Genre']}
- Disponibilités : ${disponibilites}

Nous vous contacterons prochainement avec plus de détails sur les ateliers.

Cordialement,
L'équipe du Secours Populaire
`
            });
        }

        // Redirection vers le fichier redirect.html
        return HtmlService.createHtmlOutput(
            `<html>
                <head>
                    <meta http-equiv="refresh" content="0; url=https://slybarrow.github.io/inscription-ateliers-impro/redirect.html">
                </head>
                <body>
                    <p>Redirection...</p>
                </body>
            </html>`
        ).setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);

    } catch (error) {
        // Gestion des erreurs
        return HtmlService.createHtmlOutput(`<p>Erreur : ${error.message}</p>`);
    }
}
